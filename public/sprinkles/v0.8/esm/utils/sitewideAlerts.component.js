import{h as w,p as f,a as I}from"../../_chunks/compat.module-8108cd22.js";import{S as m,M as S,D as b}from"../../_chunks/qj-0db0624e.js";import{A as M}from"../../_chunks/Alert-6717f904.js";import{o as h}from"../../_chunks/jsxRuntime.module-c4fc14d9.js";import"../../_chunks/getSVGtext-03122a1f.js";import"../../_chunks/i18n-c1727f88.js";import"../../_chunks/_Button-bb1b19a5.js";import"../../_chunks/_Link-f583270e.js";import"../../_chunks/env-e51fafad.js";import"../../_chunks/_useMobileMenuToggling-acf37f77.js";const u="alert-dismissed-",y=14*b,D=()=>{if(Math.random()>.1)return;const e=Math.floor((Date.now()-y)/m);for(let s=0;s<localStorage.length;s++){const t=localStorage.key(s);t&&t.startsWith(u)&&Number(localStorage.getItem(t))<e&&localStorage.removeItem(t)}},v=(e,s)=>t=>{const r=t.showOnPages||[];if(r.length===0)return!0;const o=t.negateShowOnPages??!0;let a=!1;for(let n=0;n<r.length;n++){const c=s.replace(/\/$/,"")+r[n];if(c.charAt(c.length-1)==="*"){if(e.startsWith(c.substring(0,c.length-1))){a=!0;break}}else if(c===e){a=!0;break}}return o?!a:a},A=e=>!(e.dismissible&&(Number(localStorage.getItem(u+e.uuid))||-1)>=(e.dismissalIgnoreBefore||0)),B=(e,s,t)=>fetch(e).then(r=>r.json()).then(r=>{const o=r.sitewideAlerts,a=Math.ceil(Date.now()/m);return o.forEach(n=>{n.dismissible?(n.dismissalIgnoreBefore||0)>a&&(n.dismissible=!1):delete n.dismissalIgnoreBefore}),o.filter(A).filter(v(s,t))}).catch(r=>(console.error("Site wide alerts failed loading",r),[])),N=e=>{const s=Math.ceil(Date.now()/m);let t=!1;const r=e.map(o=>o.dismissible||o.dismissalIgnoreBefore||0>s?o:(t=!0,{...o,dismissible:!0}));return t?r:e},T=e=>{const s=Math.floor(Date.now()/m),t=e.filter(r=>(r.dismissalIgnoreBefore||-1)>s).reduce((r,{dismissalIgnoreBefore:o=0})=>r?Math.min(r,o):o,0)-s;return t>0?t:null},O={"alert-warning":"critical","alert-attention":"warning","alert-success":"success","alert-info":"info"},k=10*m,x=2*S,W=e=>{const{alertsUri:s,baseUrl:t="/",lang:r}=e,o=Math.max(e.refreshInterval||x,k),[a,n]=w([]);f(D,[]);const c=typeof window<"u"&&window.location.pathname;f(()=>{const i=()=>{B(s,c,t).then(d=>{n(g=>g.length!==d.length||JSON.stringify(g)!==JSON.stringify(d)?d:g)})};i();const l=setInterval(i,o);return()=>{clearInterval(l)}},[c,s,t,o]),f(()=>{const i=T(a)||0;if(i>0){const l=setTimeout(()=>{n(N)},(i+2)*m);return()=>{clearTimeout(l)}}},[a]);const p=({uuid:i})=>{window.localStorage.setItem(u+i,String(Math.round(Date.now()/m))),setTimeout(()=>{n(l=>{const d=l.filter(g=>g.uuid!==i);return d.length<l.length?d:l})},2e3)};return h(I,{children:a.map(i=>{const l=O[i.styleClass]||"info";return h(M,{type:l,childrenHTML:i.renderedAlert,onClose:i.dismissible?()=>p(i):void 0,lang:r},i.uuid)})})};export{W as SiteWideAlerts};

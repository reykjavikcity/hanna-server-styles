import{C as S,h as v,p as h,_ as y}from"../../_chunks/compat.module-8a0f8b99.js";import{h as M,S as f,a as p,q as B,M as D,D as N}from"../../_chunks/qj-afc7b5d6.js";import{A as U}from"../../_chunks/Alert-a27f9ad8.js";import{k as _}from"../../_chunks/utils-96e946f5.js";import{o as u}from"../../_chunks/jsxRuntime.module-6c429607.js";import"../../_chunks/_Button-c2359514.js";import"../../_chunks/_Link-74f07e43.js";import"../../_chunks/env-7ef80a23.js";import"../../_chunks/useFormatMonitor-9c639f1c.js";const g="alert-dismissed-",k=14*N,A=()=>{if(Math.random()>.1)return;const e=Math.floor((Date.now()-k)/f);for(let r=0;r<localStorage.length;r++){const t=localStorage.key(r);t&&t.startsWith(g)&&Number(localStorage.getItem(t))<e&&localStorage.removeItem(t)}},E=e=>r=>{const t=r.showOnPages||[];if(t.length===0)return!0;const n=r.negateShowOnPages??!0;let s=!1;const o=window.location.pathname;for(let c=0;c<t.length;c++){const m=e.slice(0,-1)+t[c];if(m.charAt(m.length-1)==="*"){if(o.startsWith(m.substring(0,m.length-1))){s=!0;break}}else if(m===o){s=!0;break}}return n?!s:s},O=e=>!(e.dismissible&&(Number(localStorage.getItem(g+e.uuid))||-1)>=(e.dismissalIgnoreBefore||0)),T=(e,r)=>fetch(e).then(t=>t.json()).then(t=>{const n=t.sitewideAlerts,s=Math.ceil(Date.now()/f);return n.forEach(o=>{o.dismissible?(o.dismissalIgnoreBefore||0)>s&&(o.dismissible=!1):delete o.dismissalIgnoreBefore}),n.filter(O).filter(E(r))}).catch(t=>(console.error("Site wide alerts failed loading",t),[])),C=e=>{const r=Math.ceil(Date.now()/f);let t=!1;const n=e.map(s=>s.dismissible||s.dismissalIgnoreBefore||0>r?s:(t=!0,{...s,dismissible:!0}));return t?n:e},x=e=>{const r=Math.floor(Date.now()/f),t=e.filter(n=>(n.dismissalIgnoreBefore||-1)>r).reduce((n,{dismissalIgnoreBefore:s=0})=>n?Math.min(n,s):s,0)-r;return t>0?t:null},L={"alert-warning":"critical","alert-attention":"warning","alert-success":"success","alert-info":"info"},P=e=>{const{alertsUri:r,baseUrl:t="/",lang:n,refreshInterval:s}=e,[o,c]=v([]);h(()=>{const a=()=>{T(r,t).then(l=>{c(d=>d.length!==l.length||JSON.stringify(d)!==JSON.stringify(l)?l:d)})};a();const i=setInterval(a,s);return()=>{clearInterval(i)}},[r,t,s]),h(()=>{const a=x(o)||0;if(a>0){const i=setTimeout(()=>{c(C)},(a+2)*f);return()=>{clearTimeout(i)}}},[o]);const m=({uuid:a})=>{window.localStorage.setItem(g+a,String(Math.round(Date.now()/f))),setTimeout(()=>{c(i=>{const l=i.filter(d=>d.uuid!==a);return l.length<i.length?l:i})},2e3)};return u(y,{children:o.map(a=>{const{uuid:i,styleClass:l,message:d,dismissible:w}=a,I=L[l]||"info";return u(U,{type:I,childrenHTML:d,onClose:w?()=>m(a):void 0,lang:n},i)})})},b=e=>{const r=document.createElement("div");return e.append(r),r},W=(e,r)=>{if(typeof e=="string"){const s=p(e);if(s)return s}else if(e)return e;const t=p("."+r+"__alerts");if(t)return b(t);const n=document.createElement("div");return n.className=""+r+"__alerts",B("."+r+", body").slice(-1)[0].prepend(n),b(n)},q=10*f,J=2*D,j=e=>{A();const r=e.layoutName||"Layout",t=W(e.rootElm,r);_("Alert").then(()=>{const n=Math.max(e.refreshInterval||J,q);S.render(u(P,{alertsUri:e.alertsUri,baseUrl:e.baseUrl,refreshInterval:n,lang:M()}),t)})};export{j as default};

import{C as S,h as M,p as h,_ as v}from"../../_chunks/compat.module-edfc5ce4.js";import{S as d,a as p,q as y,M as B,D}from"../../_chunks/qj-f5658347.js";import{A as N}from"../../_chunks/Alert-72c34951.js";import{e as U,c as A}from"../../_chunks/utils-ed8ff0d8.js";import{o as u}from"../../_chunks/jsxRuntime.module-53ce29b9.js";import"../../_chunks/_Button-b5040285.js";import"../../_chunks/_Link-389e75bd.js";import"../../_chunks/env-971c3e3e.js";import"../../_chunks/useFormatMonitor-6ee15356.js";const g="alert-dismissed-",_=14*D,E=()=>{if(Math.random()>.1)return;const e=Math.floor((Date.now()-_)/d);for(let r=0;r<localStorage.length;r++){const t=localStorage.key(r);t&&t.startsWith(g)&&Number(localStorage.getItem(t))<e&&localStorage.removeItem(t)}},O=e=>r=>{const t=r.showOnPages||[];if(t.length===0)return!0;const n=r.negateShowOnPages??!0;let s=!1;const a=window.location.pathname;for(let c=0;c<t.length;c++){const m=e.slice(0,-1)+t[c];if(m.charAt(m.length-1)==="*"){if(a.startsWith(m.substring(0,m.length-1))){s=!0;break}}else if(m===a){s=!0;break}}return n?!s:s},T=e=>!(e.dismissible&&(Number(localStorage.getItem(g+e.uuid))||-1)>=(e.dismissalIgnoreBefore||0)),k=(e,r)=>fetch(e).then(t=>t.json()).then(t=>{const n=t.sitewideAlerts,s=Math.ceil(Date.now()/d);return n.forEach(a=>{a.dismissible?(a.dismissalIgnoreBefore||0)>s&&(a.dismissible=!1):delete a.dismissalIgnoreBefore}),n.filter(T).filter(O(r))}).catch(t=>(console.error("Site wide alerts failed loading",t),[])),C=e=>{const r=Math.ceil(Date.now()/d);let t=!1;const n=e.map(s=>s.dismissible||s.dismissalIgnoreBefore||0>r?s:(t=!0,{...s,dismissible:!0}));return t?n:e},x=e=>{const r=Math.floor(Date.now()/d),t=e.filter(n=>(n.dismissalIgnoreBefore||-1)>r).reduce((n,{dismissalIgnoreBefore:s=0})=>n?Math.min(n,s):s,0)-r;return t>0?t:null},L={"alert-warning":"critical","alert-attention":"warning","alert-success":"success","alert-info":"info"},P=e=>{const{alertsUri:r,baseUrl:t="/",lang:n,refreshInterval:s}=e,[a,c]=M([]);h(()=>{const o=()=>{k(r,t).then(l=>{c(f=>f.length!==l.length||JSON.stringify(f)!==JSON.stringify(l)?l:f)})};o();const i=setInterval(o,s);return()=>{clearInterval(i)}},[r,t,s]),h(()=>{const o=x(a)||0;if(o>0){const i=setTimeout(()=>{c(C)},(o+2)*d);return()=>{clearTimeout(i)}}},[a]);const m=({uuid:o})=>{window.localStorage.setItem(g+o,String(Math.round(Date.now()/d))),setTimeout(()=>{c(i=>{const l=i.filter(f=>f.uuid!==o);return l.length<i.length?l:i})},2e3)};return u(v,{children:a.map(o=>{const{uuid:i,styleClass:l,renderedAlert:f=o.message,dismissible:w}=o,I=L[l]||"info";return u(N,{type:I,childrenHTML:f,onClose:w?()=>m(o):void 0,lang:n},i)})})},b=e=>{const r=document.createElement("div");return e.append(r),r},W=(e,r)=>{if(typeof e=="string"){const s=p(e);if(s)return s}else if(e)return e;const t=p("."+r+"__alerts");if(t)return b(t);const n=document.createElement("div");return n.className=""+r+"__alerts",y("."+r+", body").slice(-1)[0].prepend(n),b(n)},q=10*d,J=2*B,j=e=>{E();const r=e.layoutName||"Layout",t=W(e.rootElm,r);U("Alert").then(()=>{const n=Math.max(e.refreshInterval||J,q);S.render(u(P,{alertsUri:e.alertsUri,baseUrl:e.baseUrl,refreshInterval:n,lang:A()}),t)})};export{j as default};
